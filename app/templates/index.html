<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Clone TTS</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; display: flex; justify-content: center; padding: 2rem; }
        .page-layout { display: flex; gap: 2rem; max-width: 1100px; width: 100%; align-items: flex-start; }
        .main-panel { flex: 1; min-width: 0; }
        .avatar-panel { width: 340px; flex-shrink: 0; }
        .avatar-panel video { width: 100%; border-radius: 12px; border: 1px solid #334155; background: #1e293b; }
        .avatar-label { font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.5rem; }
        h1 { font-size: 1.8rem; margin-bottom: 0.25rem; }
        .subtitle { color: #94a3b8; margin-bottom: 2rem; }
        .status-bar { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: #1e293b; border-radius: 8px; font-size: 0.875rem; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot.loaded { background: #22c55e; }
        .dot.unloaded { background: #ef4444; }
        .dot.loading { background: #eab308; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.4; } }
        textarea { width: 100%; min-height: 100px; padding: 0.75rem; background: #1e293b; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 1rem; resize: vertical; font-family: inherit; }
        textarea:focus { outline: none; border-color: #6366f1; }
        .controls { display: flex; gap: 0.75rem; margin-top: 1rem; }
        button { padding: 0.625rem 1.25rem; border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer; font-weight: 500; transition: opacity 0.15s; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-secondary { background: #334155; color: #e2e8f0; }
        .result { margin-top: 1.5rem; }
        audio { width: 100%; margin-top: 0.5rem; }
        .links { margin-top: 2rem; font-size: 0.875rem; color: #94a3b8; }
        .links a { color: #818cf8; text-decoration: none; }
        .links a:hover { text-decoration: underline; }
        .error { color: #f87171; margin-top: 1rem; font-size: 0.875rem; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #6366f1; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 0.5rem; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .gpu-badge { position: fixed; top: 1rem; right: 1rem; background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 0.5rem 0.75rem; font-size: 0.75rem; color: #94a3b8; line-height: 1.5; z-index: 100; }
        .gpu-badge .label { color: #64748b; }
        .gpu-badge .value { color: #e2e8f0; font-variant-numeric: tabular-nums; }
        @media (max-width: 800px) {
            .page-layout { flex-direction: column; }
            .avatar-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="gpu-badge" id="gpuBadge">
        <div><span class="label">VRAM </span><span class="value" id="gpuVram">--</span></div>
        <div><span class="label">GPU  </span><span class="value" id="gpuUtil">--</span></div>
    </div>
    <div class="page-layout">
        <div class="main-panel">
            <h1>Voice Clone TTS</h1>
            <p class="subtitle">Text-to-speech with cloned voices</p>

            <div class="status-bar">
                <span class="dot" id="statusDot"></span>
                <span id="statusText">Checking...</span>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="voiceSelect" style="font-size: 0.875rem; color: #94a3b8; display: block; margin-bottom: 0.375rem;">Voice</label>
                <select id="voiceSelect" style="padding: 0.5rem 0.75rem; background: #1e293b; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 0.95rem; cursor: pointer;"></select>
            </div>

            <textarea id="textInput" placeholder="Enter text to synthesize..."></textarea>

            <div class="controls">
                <button class="btn-primary" id="generateBtn" onclick="generate()">Generate</button>
                <button class="btn-secondary" id="downloadBtn" style="display:none" onclick="download()">Download WAV</button>
            </div>

            <div id="error" class="error"></div>

            <div class="result" id="result" style="display:none">
                <audio id="audioPlayer" controls></audio>
            </div>

            <div class="links">
                <a href="/docs">API Documentation (Swagger)</a> &middot; <a href="/redoc">ReDoc</a>
            </div>
        </div>

        <div class="avatar-panel">
            <p class="avatar-label">Avatar</p>
            <video id="avatarVideo" autoplay loop muted playsinline controls></video>
        </div>
    </div>

    <script>
        let lastBlob = null;

        const voiceConfig = __VOICE_CONFIG__;
        const defaultVoice = __DEFAULT_VOICE__;

        // Populate voice dropdown from config
        const voiceSelect = document.getElementById('voiceSelect');
        Object.keys(voiceConfig).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name.charAt(0).toUpperCase() + name.slice(1);
            if (name === defaultVoice) opt.selected = true;
            voiceSelect.appendChild(opt);
        });

        // Set initial text and avatar from config
        document.getElementById('textInput').value = voiceConfig[defaultVoice].default_text;
        document.getElementById('avatarVideo').src = voiceConfig[defaultVoice].avatar_video;

        voiceSelect.addEventListener('change', function() {
            const cfg = voiceConfig[this.value];
            if (cfg) {
                document.getElementById('textInput').value = cfg.default_text;
                const el = document.getElementById('avatarVideo');
                el.src = cfg.avatar_video;
                el.load();
            }
        });

        async function checkStatus() {
            try {
                const r = await fetch('/api/status');
                const d = await r.json();
                const dot = document.getElementById('statusDot');
                const txt = document.getElementById('statusText');
                if (d.model_loaded) {
                    dot.className = 'dot loaded';
                    txt.textContent = `Model loaded (GPU: ${d.gpu.allocated_gb} GB used)`;
                } else {
                    dot.className = 'dot unloaded';
                    txt.textContent = 'Model not loaded';
                }
            } catch {
                document.getElementById('statusDot').className = 'dot unloaded';
                document.getElementById('statusText').textContent = 'Service unavailable';
            }
        }

        async function generate() {
            const btn = document.getElementById('generateBtn');
            const err = document.getElementById('error');
            const text = document.getElementById('textInput').value.trim();
            err.textContent = '';
            if (!text) { err.textContent = 'Please enter some text.'; return; }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Generating...';
            document.getElementById('result').style.display = 'none';
            document.getElementById('downloadBtn').style.display = 'none';

            // Show loading status while model might be loading
            document.getElementById('statusDot').className = 'dot loading';
            document.getElementById('statusText').textContent = 'Generating...';

            try {
                const r = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text, voice: document.getElementById('voiceSelect').value})
                });
                if (!r.ok) {
                    const d = await r.json().catch(() => ({}));
                    throw new Error(d.detail || `HTTP ${r.status}`);
                }
                lastBlob = await r.blob();
                const url = URL.createObjectURL(lastBlob);
                const player = document.getElementById('audioPlayer');
                player.src = url;
                document.getElementById('result').style.display = 'block';
                document.getElementById('downloadBtn').style.display = 'inline-block';
                player.play();
            } catch (e) {
                err.textContent = 'Error: ' + e.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate';
                checkStatus();
            }
        }

        function download() {
            if (!lastBlob) return;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(lastBlob);
            a.download = 'output.wav';
            a.click();
        }

        checkStatus();
        setInterval(checkStatus, 30000);

        // GPU stats WebSocket
        function connectGpuWs() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${proto}//${location.host}/api/ws/gpu`);
            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                document.getElementById('gpuVram').textContent = `${d.vram_used_pct}% (${d.vram_used_gb}/${d.vram_total_gb} GB)`;
                document.getElementById('gpuUtil').textContent = `${d.gpu_util_pct}%`;
            };
            ws.onclose = () => setTimeout(connectGpuWs, 1000);
            ws.onerror = () => ws.close();
        }
        connectGpuWs();
    </script>
</body>
</html>
